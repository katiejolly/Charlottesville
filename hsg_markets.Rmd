---
title: "Housing Markets in Charlottesville, VA"
author: "Katie Jolly"
date: "November 21, 2017"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: "cosmo"
---

# Packages and data

```{r message=FALSE, warning=FALSE}
library(leaflet)
library(tigris)
library(tidyverse)
library(tidycensus)
med_hsgvalue_2015 <- read_csv("ACS_15_5YR_B25077_with_ann.csv")
med_hsgvalue_2010 <- read_csv("ACS_10_5YR_B25077_with_ann.csv")
```

# Cleaning data

```{r}
# function to clean the two tables

clean_table <- function(df) {
  d <- df
  colnames(d) <- c("Id", "GEOID", "Tract", "Value", "MOE")
  d <- d[-1, ]
  d$Value <- as.numeric(d$Value)
  d$MOE <- as.numeric(d$MOE)
  d <- separate(d, Tract, c("Tract", "County"), ",")
  d$Tract <- substring(d$Tract, first = 14, last = length(d$Tract))
  return(d)
}
```


```{r message=FALSE, warning=FALSE}
# create clean versions of the data

cpi_10 <- mean(c(187.1, 193.233, 200.388, 202.217, 200.853))

cpi_15 <- mean(c(221.495, 206.995, 211.299, 207.254, 203.627))

cpi_rate <- cpi_15/cpi_10

med_value_15_clean <- clean_table(med_hsgvalue_2015)

med_value_10_clean <- clean_table(med_hsgvalue_2010) %>%
  mutate(Value_10_real = cpi_rate * Value)
```

# Calculations


```{r}
msa_med_value_10_real <- median(med_value_10_clean$Value_10_real, na.rm = TRUE)

msa_med_value_15 <- median(med_value_15_clean$Value, na.rm = TRUE)

msa_sd_10_real <- round(sd(med_value_10_clean$Value_10_real, na.rm = TRUE), 3)
msa_sd_15 <- round(sd(med_value_15_clean$Value, na.rm = TRUE), 3)

med_value_10_clean <- med_value_10_clean %>%
  mutate(Ratio_10_real = round(Value_10_real/msa_med_value_10, 2))

med_value_15_clean <- med_value_15_clean %>%
  mutate(Ratio_15 = round(Value/msa_med_value_15, 2))
```


```{r}
colnames(med_value_15_clean) <- c("Id", "GEOID", "Tract", "County", "Value_15", "MOE_15", "Ratio_15")
colnames(med_value_10_clean) <- c("Id", "GEOID", "Tract", "County", "Value_10", "MOE_10", "Value_10_real", "Ratio_10_real")

cville_hsg_market <- med_value_10_clean %>%
  inner_join(med_value_15_clean, by = c("Id", "GEOID", "Tract", "County")) %>%
  mutate(pct_change_ratio = round((Ratio_15 - Ratio_10_real)/Ratio_10_real, 2)) 
```

```{r message=FALSE, warning=FALSE}
cville_tracts <- tracts(state = "VA", county = c("Albemarle", "Fluvanna", "Greene", "Nelson", "Charlottesville city", "Buckingham"))

cville_hsg_geo <- geo_join(cville_tracts, cville_hsg_market, by_sp = "GEOID", by_df = "GEOID", how = "inner")
```

```{r}
labels <- sprintf(
  "<strong>%s Count</strong><br/> %g ",
  cville_hsg_geo$County, cville_hsg_geo$Tract
) %>% lapply(htmltools::HTML)

pal <- colorBin("BuPu", cville_hsg_geo$Ratio_10, 4)

leaflet(cville_hsg_geo) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal(Ratio_10),
    fillOpacity = 0.4,
    color = "Black",
    weight = 0.7,
    highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = labels,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>%
  addLegend(
    position = "bottomright",
    pal = pal,
    values = ~Ratio_10,
    title = "Ratio, 2010"
  ) %>%
  addMiniMap(
    tiles = providers$CartoDB.Positron,
    position="topright",
    toggleDisplay = TRUE
  )
  
```

